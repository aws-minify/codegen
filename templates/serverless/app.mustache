'use strict';

var fs = require('fs'),
  path = require('path');
var express = require('express')
var bodyParser = require('body-parser')
var awsServerlessExpressMiddleware = require('aws-serverless-express/middleware')

// The Swagger document (require it, build it programmatically, fetch it from a URL, ...)
let specYAML = path.join(__dirname, 'specs/{{apiName}}/openapi.yaml');
const swagger = require('swagger-express-middleware');
const Middleware = swagger.Middleware;

let app = express()
let middleware = new Middleware(app);

middleware.init(specYAML, (err) => {
  app.use(bodyParser.json())
  app.use(awsServerlessExpressMiddleware.eventContext())
  app.use(middleware.metadata());

  // These two middleware don't have any options (yet)
  app.use(middleware.CORS(), middleware.validateRequest());
  // Route validated requests to appropriate controller
  {{#services}}
  {{#servicePoints}}
  {{#operations}}
  app.use(require("./{{apiName}}/{{serviceName}}/controllers/{{operationId}}"));
  {{/operations}}  
  {{/servicePoints}}
  {{/services}}

   // The mock middleware will use our custom data store,
  // which we already pre-populated with mock data
  //app.use(middleware.mock(myDB));

  // Global application error handler
  app.use(function (err, req, res, next, statusCode) {
    if (res.headersSent) {
      return next(err);
    } else {
      res.status(statusCode || 500).json({
        code: "ErrorServiceProviderSystemException",
        message: err.message,
        error: err
      });
    }
  });

  app.listen(3000, function () {
    console.log("Server is started")
  })

})